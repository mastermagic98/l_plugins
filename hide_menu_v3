(function () {
    'use strict';

    if (Lampa.Manifest.app_digital < 300) return;

    var plugin_name = 'hide_menu_items';

    var settings = {
        hide_sport: false,
        hide_timeline: false,
        hide_torrents: false,
        hide_schedule: false,
        hide_subscriptions: false,
        hide_bookmarks: false,
        hide_anime: false,
        hide_catalog: false,
        hide_persons: false,
        hide_info: false,
        hide_console: false,
        hide_settings: false,
        hide_filter: false
    };

    function loadSettings() {
        var saved = Lampa.Storage.get(plugin_name, '{}');
        try { Object.assign(settings, JSON.parse(saved));
        catch (e) {}
    }

    function saveSettings() {
        Lampa.Storage.set(plugin_name, JSON.stringify(settings));
    }

    function hideMenuItems() {
        var menuSelectors = {
            sport: { enabled: settings.hide_sport, selectors: ['.menu__item[data-action="sport"], .sidebar__item[data-action="sport"], [data-action="sport"]:not(.head__action)' ] },
            timeline: { enabled: settings.hide_timeline, selectors: ['.menu__item[data-action="timeline"]', '.sidebar__item[data-action="timeline"]', '[data-action="timeline"]:not(.head__action)'] },
            torrents: { enabled: settings.hide_torrents, selectors: ['.menu__item[data-action="torrents"]', '.sidebar__item[data-action="torrents"]', '[data-action="torrents"]:not(.head__action)'] },
            schedule: { enabled: settings.hide_schedule, selectors: ['.menu__item[data-action="schedule"]', '.sidebar__item[data-action="schedule"]', '[data-action="schedule"]:not(.head__action)'] },
            subscriptions: { enabled: settings.hide_subscriptions, selectors: ['.menu__item[data-action="subscriptions"]', '.sidebar__item[data-action="subscriptions"]', '[data-action="subscriptions"]:not(.head__action)'] },
            bookmarks: { enabled: settings.hide_bookmarks, selectors: ['.menu__item[data-action="bookmarks"]', '.sidebar__item[data-action="bookmarks"]', '[data-action="bookmarks"]:not(.head__action)'] },
            anime: { enabled: settings.hide_anime, selectors: ['.menu__item[data-action="anime"]', '.sidebar__item[data-action="anime"]', '[data-action="anime"]:not(.head__action)'] },
            catalog: { enabled: settings.hide_catalog, selectors: ['.menu__item[data-action="catalog"]', '.sidebar__item[data-action="catalog"]', '[data-action="catalog"]:not(.head__action)'] },
            persons: { enabled: settings.hide_persons, selectors: ['.menu__item[data-action="persons"]', '.sidebar__item[data-action="persons"]', '[data-action="persons"]:not(.head__action)'] },
            info: { enabled: settings.hide_info, selectors: ['.menu__item[data-action="info"]', '.sidebar__item[data-action="info"]', '[data-action="info"]:not(.head__action)', '.menu__item[data-component="info"]'] },
            console: { enabled: settings.hide_console, selectors: ['.menu__item[data-action="console"]', '.sidebar__item[data-action="console"]', '[data-action="console"]:not(.head__action)'] },
            settings: { enabled: settings.hide_settings, selectors: ['.menu__item[data-action="settings"]', '.sidebar__item[data-action="settings"]'] },
            filter: { enabled: settings.hide_filter, selectors: ['.menu__item[data-action="filter"]', '.sidebar__item[data-action="filter"]', '[data-action="filter"]:not(.head__action)'] }
        };

        Object.keys(menuSelectors).forEach(function (key) {
            var cfg = menuSelectors[key];
            cfg.selectors.forEach(function (sel) {
                $(sel).toggle(!cfg.enabled);
            });
        });
    }

    function showAllMenuItems() {
        Object.keys(settings).forEach(function (k) { settings[k] = false; });
        saveSettings();
        hideMenuItems();
    }

    function openSettingsMenu() {
        var items = [];

        items.push({ title: 'Приховування пунктів меню', separator: true });

        var names = {
            hide_sport: 'Спорт',
            hide_timeline: 'Стрічка',
            hide_torrents: 'Торренти',
            hide_schedule: 'Розклад',
            hide_subscriptions: 'Підписки',
            hide_bookmarks: 'Вибране',
            hide_anime: 'Аніме',
            hide_catalog: 'Каталог',
            hide_persons: 'Особи',
            hide_info: 'Інформація',
            hide_console: 'Консоль',
            hide_settings: 'Налаштування (в меню)',
            hide_filter: 'Фільтр'
        };

        Object.keys(names).forEach(function (key) {
            items.push({
                title: names[key],
                checkbox: true,                    // включає квадратний чекбокс
                checked: settings[key],           // галочка чи ні
                key: key
            });
        });

        items.push({ title: 'Додатково', separator: true });
        items.push({
            title: 'Показати всі пункти',
            action: 'show_all'
        });

        Lampa.Select.show({
            title: 'Приховування меню',
            items: items,
            onSelect: function (item) {
                if (item.action === 'show_all') {
                    showAllMenuItems();
                    openSettingsMenu();
                    return;
                }

                if (item.key) {
                    settings[item.key] = !settings[item.key];
                    saveSettings();
                    hideMenuItems();
                    openSettingsMenu(); // оновлюємо чекбокси
                }
            },
            onBack: function () {
                Lampa.Controller.toggle('settings_component');
            }
        });
    }

    // === Додаємо пункт у налаштувань ===
    Lampa.SettingsApi.addComponent({
        component: 'hide_menu_plugin',
        name: 'Приховування меню',
        icon: '<svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z" fill="#fff"/></svg>'
    });

    Lampa.SettingsApi.addParam({
        component: 'hide_menu_plugin',
        param: { name: 'open_menu', type: 'trigger', default: false },
        field: { name: 'Приховування меню', description: 'Налаштування видимості пунктів меню' },
        onRender: function (el) {
            el.off('hover:enter').on('hover:enter', openSettingsMenu);
        }
    });

    // === Спостереження ===
    var observer = new MutationObserver(hideMenuItems);
    observer.observe(document.body, { childList: true, subtree: true });

    Lampa.Listener.follow('app', function (e) {
        if (e.type === 'ready') {
            loadSettings();
            setTimeout(hideMenuItems, 1000);
        }
    });

    Lampa.Listener.follow('full', function (e) {
        if (e.type === 'start') setTimeout(hideMenuItems, 500);
    });

})();
